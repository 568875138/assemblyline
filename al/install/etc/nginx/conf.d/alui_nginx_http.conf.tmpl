server {
    server_name              {{ seed['ui']['fqdn'] }};
    listen                   80;
    charset                  utf-8;
    client_max_body_size  100M;

    location /static {
        root /opt/al/pkg/assemblyline/ui;
    }
    
    location /socket.io/ {
        proxy_set_header    X-Remote-User   $remote_user;
        proxy_set_header    X-Forward-For   $proxy_add_x_forwarded_for;
        proxy_set_header    Host            $http_host;
        proxy_redirect      off;
        proxy_buffering     off;
        proxy_http_version  1.1;
        proxy_set_header    Upgrade         $http_upgrade;
        proxy_set_header    Connection      "upgrade";

        proxy_pass          http://127.0.0.1:8000;

        proxy_intercept_errors on;
        error_page 502 = @socketio_dbg;
    }
    location @socketio_dbg {
        proxy_set_header    X-Remote-User   $remote_user;
        proxy_set_header    X-Forward-For   $proxy_add_x_forwarded_for;
        proxy_set_header    Host            $http_host;
        proxy_redirect      off;
        proxy_buffering     off;
        proxy_http_version  1.1;
        proxy_set_header    Upgrade         $http_upgrade;
        proxy_set_header    Connection      "upgrade";

        proxy_pass          http://127.0.0.1:5002;
    }

    location / {
        try_files $uri @alweb;
    }
    location @alweb {
        add_header            X-Frame-Options              DENY;

        proxy_set_header      Host          $http_host;
        proxy_set_header      Scheme        $scheme;
        proxy_set_header      Server-Port   $server_port;
        proxy_pass_header     Authorization;
        include               uwsgi_params;
        uwsgi_buffering       off;
        uwsgi_pass            unix:/opt/al/var/www/alui_uwsgi.sock;
        uwsgi_param           UWSGI_CHDIR   /opt/al/pkg/assemblyline/ui/;

        uwsgi_intercept_errors on;
        error_page 502 = @alweb_dbg;
    }
    location @alweb_dbg {
        add_header            X-Frame-Options  DENY;
        proxy_set_header      Host             $http_host;
        proxy_set_header      Scheme           $scheme;
        proxy_set_header      Server-Port      $server_port;
        proxy_pass_header     Autorization;

        proxy_pass            http://localhost:5000;
    }

    location ~ /git(/.*) {
        allow                {{seed['ui']['allowed_checkout_range']}};
        deny                 all;

        client_max_body_size 0;

        fastcgi_param        SCRIPT_FILENAME      /usr/lib/git-core/git-http-backend;
        include              fastcgi_params;
        fastcgi_param        GIT_HTTP_EXPORT_ALL  "";
        fastcgi_param        GIT_PROJECT_ROOT     /opt/al/pkg/;
        fastcgi_param        PATH_INFO            $1;

        fastcgi_pass         unix:/var/run/fcgiwrap.socket;
    }
}
